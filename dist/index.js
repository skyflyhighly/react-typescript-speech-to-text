import{useState as t,useRef as e,useEffect as n}from"react";var o=function(){return(o=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function i(t,e,n,o){return new(n||(n=Promise))((function(i,r){function a(t){try{c(o.next(t))}catch(t){r(t)}}function s(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((o=o.apply(t,e||[])).next())}))}function r(t,e){var n,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function s(r){return function(s){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,o=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=e.call(t,a)}catch(t){r=[6,t],o=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,s])}}}function a(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var o=Array(t),i=0;for(e=0;e<n;e++)for(var r=arguments[e],a=0,s=r.length;a<s;a++,i++)o[i]=r[a];return o}var s,c=l;function l(){}l.mixin=function(t){var e=t.prototype||t;e.isWildEmitter=!0,e.on=function(t,e,n){this.callbacks=this.callbacks||{};var o=3===arguments.length,i=o?arguments[1]:void 0,r=o?arguments[2]:arguments[1];return r._groupName=i,(this.callbacks[t]=this.callbacks[t]||[]).push(r),this},e.once=function(t,e,n){var o=this,i=3===arguments.length,r=i?arguments[1]:void 0,a=i?arguments[2]:arguments[1];function s(){o.off(t,s),a.apply(this,arguments)}return this.on(t,r,s),this},e.releaseGroup=function(t){var e,n,o,i;for(e in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,o=(i=this.callbacks[e]).length;n<o;n++)i[n]._groupName===t&&(i.splice(n,1),n--,o--);return this},e.off=function(t,e){this.callbacks=this.callbacks||{};var n,o=this.callbacks[t];return o?1===arguments.length?(delete this.callbacks[t],this):(-1!==(n=o.indexOf(e))&&(o.splice(n,1),0===o.length&&delete this.callbacks[t]),this):this},e.emit=function(t){this.callbacks=this.callbacks||{};var e,n,o,i=[].slice.call(arguments,1),r=this.callbacks[t],a=this.getWildcardCallbacks(t);if(r)for(e=0,n=(o=r.slice()).length;e<n&&o[e];++e)o[e].apply(this,i);if(a)for(n=a.length,e=0,n=(o=a.slice()).length;e<n&&o[e];++e)o[e].apply(this,[t].concat(i));return this},e.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var e,n,o=[];for(e in this.callbacks)n=e.split("*"),("*"===e||2===n.length&&t.slice(0,n[0].length)===n[0])&&(o=o.concat(this.callbacks[e]));return o}},l.mixin(l),"undefined"!=typeof window&&(s=window.AudioContext||window.webkitAudioContext);var u=null,f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},h=!!(f===f.window&&f.URL&&f.Blob&&f.Worker);function d(t,e){var n,o=this;if(e=e||{},h)return n=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new f.Worker(f.URL.createObjectURL(new f.Blob([n],{type:"text/javascript"})));this.self=e,this.self.postMessage=function(t){setTimeout((function(){o.onmessage({data:t})}),0)},setTimeout(t.bind(e,e),0)}d.prototype.postMessage=function(t){var e=this;setTimeout((function(){e.self.onmessage({data:t})}),0)};var p=d;class g{constructor(t,e){this.config={bufferLen:4096,numChannels:1,mimeType:"audio/wav",...e},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},this.context=t.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=t=>{if(this.recording){for(var e=[],n=0;n<this.config.numChannels;n++)e.push(t.inputBuffer.getChannelData(n));this.worker.postMessage({command:"record",buffer:e})}},t.connect(this.node),this.node.connect(this.context.destination);this.worker=new p((function(){let t,e,n,o=0,i=[];function r(){for(let t=0;t<e;t++)i[t]=[]}function a(t,e){let n=new Float32Array(e),o=0;for(let e=0;e<t.length;e++)n.set(t[e],o),o+=t[e].length;return n}function s(t,e,n){for(let o=0;o<n.length;o++)t.setUint8(e+o,n.charCodeAt(o))}this.onmessage=function(c){switch(c.data.command){case"init":l=c.data.config,t=l.sampleRate,e=l.numChannels,r(),n=t>48e3?48e3:t;break;case"record":!function(t){for(var n=0;n<e;n++)i[n].push(t[n]);o+=t[0].length}(c.data.buffer);break;case"exportWAV":!function(r){let c,l=[];for(let t=0;t<e;t++)l.push(a(i[t],o));c=2===e?function(t,e){let n=t.length+e.length,o=new Float32Array(n),i=0,r=0;for(;i<n;)o[i++]=t[r],o[i++]=e[r],r++;return o}(l[0],l[1]):l[0];let u=function(t){let o=new ArrayBuffer(44+2*t.length),i=new DataView(o);return s(i,0,"RIFF"),i.setUint32(4,36+2*t.length,!0),s(i,8,"WAVE"),s(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,e,!0),i.setUint32(24,n,!0),i.setUint32(28,4*n,!0),i.setUint16(32,2*e,!0),i.setUint16(34,16,!0),s(i,36,"data"),i.setUint32(40,2*t.length,!0),function(t,e,n){for(let o=0;o<n.length;o++,e+=2){let i=Math.max(-1,Math.min(1,n[o]));t.setInt16(e,i<0?32768*i:32767*i,!0)}}(i,44,t),i}(function(e,n){if(n==t)return e;if(n>t)throw"downsampling rate show be smaller than original sample rate";var o=t/n,i=Math.round(e.length/o),r=new Float32Array(i),a=0,s=0;for(;a<r.length;){for(var c=Math.round((a+1)*o),l=0,u=0,f=s;f<c&&f<e.length;f++)l+=e[f],u++;r[a]=l/u,a++,s=c}return r}(c,n)),f=new Blob([u],{type:r});this.postMessage({command:"exportWAV",data:f})}(c.data.type);break;case"getBuffer":!function(){let t=[];for(let n=0;n<e;n++)t.push(a(i[n],o));this.postMessage({command:"getBuffer",data:t})}();break;case"clear":o=0,i=[],r()}var l}}),{}),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=t=>{let e=this.callbacks[t.data.command].pop();"function"==typeof e&&e(t.data.data)}}record(){this.recording=!0}stop(){this.recording=!1}clear(){this.worker.postMessage({command:"clear"})}getBuffer(t){if(!(t=t||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(t),this.worker.postMessage({command:"getBuffer"})}exportWAV(t,e){if(e=e||this.config.mimeType,!(t=t||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(t),this.worker.postMessage({command:"exportWAV",type:e})}static forceDownload(t,e){let n=(window.URL||window.webkitURL).createObjectURL(t),o=window.document.createElement("a");o.href=n,o.download=e||"output.wav";let i=document.createEvent("Event");i.initEvent("click",!0,!0),o.dispatchEvent(i)}}let v,m,w=g;async function b({audioContext:t,errHandler:e,onStreamLoad:n}){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});return n&&n(),v=e,m=t.createMediaStreamSource(e),w=new g(m),w.record(),e}catch(t){console.log(t),e&&e()}}function k({exportWAV:t,wavCallback:e}){w.stop(),v.getAudioTracks()[0].stop(),t&&e&&w.exportWAV((t=>e(t))),w.clear()}var y,x=-1!==navigator.userAgent.indexOf("Edg/"),A=window.AudioContext||window.webkitAudioContext,C=window.SpeechRecognition||window.webkitSpeechRecognition;function T(l){var f=this,h=l.continuous,d=l.crossBrowser,p=l.googleApiKey,g=l.googleCloudRecognitionConfig,v=l.onStartSpeaking,m=l.onStoppedSpeaking,w=l.speechRecognitionProperties,x=l.timeout,C=t(!1),T=C[0],S=C[1],R=e(),M=t([]),U=M[0],W=M[1],E=t(""),B=E[0],H=E[1],V=e(),L=e();n((function(){var t;d||y||H("Speech Recognition API is only available on Chrome"),(null===(t=null===navigator||void 0===navigator?void 0:navigator.mediaDevices)||void 0===t?void 0:t.getUserMedia)||H("getUserMedia is not supported on this device/browser :("),R.current||(R.current=new A)}),[]);var O=function(){return i(f,void 0,void 0,(function(){var t,e,n,o;return r(this,(function(i){switch(i.label){case 0:return y?(function(){if(y){if(h&&(y.continuous=!0),w){var t=w.grammars,e=w.interimResults,n=w.lang,o=w.maxAlternatives;t&&(y.grammars=t),n&&(y.lang=n),y.interimResults=e||!1,y.maxAlternatives=o||1}y.start(),y.onresult=function(t){t.results&&W((function(e){return a(e,[t.results[t.results.length-1][0].transcript])}))},y.onaudiostart=function(){return S(!0)},y.onaudioend=function(){S(!1)}}}(),[2]):d?("suspended"===(null===(n=R.current)||void 0===n?void 0:n.state)&&(null===(o=R.current)||void 0===o||o.resume()),[4,b({errHandler:function(){return H("Microphone permission was denied")},audioContext:R.current})]):[2];case 1:return t=i.sent(),x&&F(),L.current&&L.current.getAudioTracks()[0].stop(),L.current=t.clone(),(e=function(t,e){var n=new c;if(!s)return n;var o,i,r,a=(e=e||{}).smoothing||.1,l=e.interval||50,f=e.threshold,h=e.play,d=e.history||10,p=!0;u=e.audioContext||u||new s,(r=u.createAnalyser()).fftSize=512,r.smoothingTimeConstant=a,i=new Float32Array(r.frequencyBinCount),t.jquery&&(t=t[0]),t instanceof HTMLAudioElement||t instanceof HTMLVideoElement?(o=u.createMediaElementSource(t),void 0===h&&(h=!0),f=f||-50):(o=u.createMediaStreamSource(t),f=f||-50),o.connect(r),h&&r.connect(u.destination),n.speaking=!1,n.suspend=function(){return u.suspend()},n.resume=function(){return u.resume()},Object.defineProperty(n,"state",{get:function(){return u.state}}),u.onstatechange=function(){n.emit("state_change",u.state)},n.setThreshold=function(t){f=t},n.setInterval=function(t){l=t},n.stop=function(){p=!1,n.emit("volume_change",-100,f),n.speaking&&(n.speaking=!1,n.emit("stopped_speaking")),r.disconnect(),o.disconnect()},n.speakingHistory=[];for(var g=0;g<d;g++)n.speakingHistory.push(0);var v=function(){setTimeout((function(){if(p){var t=function(t,e){var n=-1/0;t.getFloatFrequencyData(e);for(var o=4,i=e.length;o<i;o++)e[o]>n&&e[o]<0&&(n=e[o]);return n}(r,i);n.emit("volume_change",t,f);var e=0;if(t>f&&!n.speaking){for(var o=n.speakingHistory.length-3;o<n.speakingHistory.length;o++)e+=n.speakingHistory[o];e>=2&&(n.speaking=!0,n.emit("speaking"))}else if(t<f&&n.speaking){for(o=0;o<n.speakingHistory.length;o++)e+=n.speakingHistory[o];0==e&&(n.speaking=!1,n.emit("stopped_speaking"))}n.speakingHistory.shift(),n.speakingHistory.push(0+(t>f)),v()}}),l)};return v(),n}(L.current,{audioContext:R.current})).on("speaking",(function(){v&&v(),clearTimeout(V.current)})),e.on("stopped_speaking",(function(){var t;m&&m(),S(!1),null===(t=L.current)||void 0===t||t.getAudioTracks()[0].stop(),k({exportWAV:!0,wavCallback:function(t){return j({blob:t,continuous:h||!1})}})})),S(!0),[2]}}))}))},F=function(){V.current=window.setTimeout((function(){var t;S(!1),null===(t=L.current)||void 0===t||t.getAudioTracks()[0].stop(),k({exportWAV:!1})}),x)},j=function(t){var e=t.blob,n=t.continuous,s=new FileReader;s.readAsDataURL(e),s.onloadend=function(){return i(f,void 0,void 0,(function(){var t,e,i,c,l,u,f,h;return r(this,(function(r){switch(r.label){case 0:return t=s.result,(e=null===(f=R.current)||void 0===f?void 0:f.sampleRate)&&e>48e3&&(e=48e3),i={content:""},c=o({encoding:"LINEAR16",languageCode:"en-US",sampleRateHertz:e},g),l={config:c,audio:i},i.content=t.substr(t.indexOf(",")+1),[4,fetch("https://speech.googleapis.com/v1/speech:recognize?key="+p,{method:"POST",body:JSON.stringify(l)})];case 1:return[4,r.sent().json()];case 2:return u=r.sent(),(null===(h=u.results)||void 0===h?void 0:h.length)>0&&W((function(t){return a(t,[u.results[0].alternatives[0].transcript])})),n&&O(),[2]}}))}))}};return{results:U,startSpeechToText:O,stopSpeechToText:function(){var t;y?y.stop():(S(!1),null===(t=L.current)||void 0===t||t.getAudioTracks()[0].stop(),k({exportWAV:!0,wavCallback:function(t){return j({blob:t,continuous:!1})}}))},isRecording:T,error:B}}navigator.brave&&navigator.brave.isBrave().then((function(t){t&&(y=null)})),!x&&C&&(y=new C);export default T;
//# sourceMappingURL=index.js.map
